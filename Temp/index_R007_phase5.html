<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cooking App - Phase 5</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <script>tailwind.config={theme:{extend:{colors:{'cream':'#FDF8F3','terracotta':'#C4704F','sage':'#87A878','charcoal':'#2D3436','warm-gray':'#636E72','light-gray':'#B2BEC3','butter':'#F6E58D','tomato':'#E55039','purple':'#6C5CE7'}}}}</script>
  <style>body{font-family:system-ui;background:#FDF8F3;margin:0}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.fade{animation:fadeIn .3s}</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useMemo,useCallback}=React;
const db=new Dexie('CookingAppDB');
db.version(3).stores({ingredients:'id,name',dishes:'id,name,status',intermediates:'id,name'});
const gid=()=>'id_'+Math.random().toString(36).substr(2,9)+Date.now().toString(36);

const I={
  Pkg:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16.5 9.4 7.55 4.24M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/></svg>,
  Dish:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7M2.1 21.8l6.4-6.3M19 5l-7 7"/></svg>,
  Cart:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>,
  Layer:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65M22 12.65l-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>,
  Plus:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14M12 5v14"/></svg>,
  Edit:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>,
  Del:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
  X:()=><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18M6 6l12 12"/></svg>,
};

const Modal=({open,close,title,ch})=>!open?null:(<div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="absolute inset-0 bg-charcoal/50" onClick={close}/><div className="relative w-full max-w-md bg-white rounded-2xl shadow-lg fade max-h-[90vh] overflow-y-auto"><div className="flex justify-between px-6 py-4 border-b sticky top-0 bg-white"><h2 className="font-semibold text-xl">{title}</h2><button onClick={close} className="p-2 rounded-lg text-warm-gray hover:bg-light-gray/30"><I.X/></button></div><div className="px-6 py-4">{ch}</div></div></div>);
const Toast=({msg,type,onDone})=>{React.useEffect(()=>{const t=setTimeout(onDone,3000);return()=>clearTimeout(t)},[]);const bg={error:'bg-tomato',success:'bg-sage',warn:'bg-amber-500'}[type]||'bg-charcoal';return<div className="fixed top-4 left-1/2 -translate-x-1/2 z-[60] fade"><div className={`${bg} text-white px-5 py-3 rounded-xl shadow-lg text-sm font-medium max-w-sm text-center`}>{msg}</div></div>};

const spg=i=>{if(!i.purchasedAt||!i.shelfLifeDays)return{st:'Unknown',d:null};const e=new Date(i.purchasedAt);e.setDate(e.getDate()+i.shelfLifeDays);const d=Math.ceil((e-new Date())/864e5);return{st:d<0?'Expired':d<=3?'NearExpiry':'Fresh',d}};
const SpBadge=({st,d})=>{const c={Fresh:'bg-sage/20 text-sage',NearExpiry:'bg-butter/40 text-yellow-700',Expired:'bg-tomato/20 text-tomato',Unknown:'bg-light-gray/30 text-warm-gray'}[st]||'bg-light-gray/30';const l={Fresh:'Fresh',NearExpiry:'Soon',Expired:'Expired',Unknown:'?'}[st];return<span className={`text-xs px-2 py-0.5 rounded-full ${c}`}>{l}{d!==null&&` ${d}d`}</span>};
const PriBadge=({p})=>{const c={1:'bg-tomato/10 text-tomato',2:'bg-amber-100 text-amber-700'}[p]||'bg-light-gray/30';const l={1:'Urgent',2:'High',3:'Normal',4:'Low',5:'Someday'}[p];return<span className={`text-xs px-2 py-0.5 rounded-full ${c}`}>{l}</span>};

const chkDish=(d,ings,ints)=>{const im=new Map(ings.map(i=>[i.id,i])),itm=new Map(ints.map(i=>[i.id,i]));if(!d.recipeIngredients?.length&&!d.recipeIntermediates?.length)return{ok:false,ul:true,mi:[],mt:[]};const mi=(d.recipeIngredients||[]).filter(e=>{const i=im.get(e.ingredientId);return!i||i.stockQty<e.qty}).map(e=>im.get(e.ingredientId)?.name||'?');const mt=(d.recipeIntermediates||[]).filter(e=>{const i=itm.get(e.intermediateId);return!i||i.stockQty<e.qty}).map(e=>itm.get(e.intermediateId)?.name||'?');return{ok:!mi.length&&!mt.length,ul:false,mi,mt}};
const chkInt=(t,ings)=>{if(!t.inputIngredients?.length)return{ok:false,ul:true};const im=new Map(ings.map(i=>[i.id,i]));return{ok:!t.inputIngredients.some(e=>{const i=im.get(e.ingredientId);return!i||i.stockQty<e.qtyPerUnit}),ul:false}};

const agg=(dishes,ings,ints)=>{const act=dishes.filter(d=>d.status!=='Cooked'),ir=new Map(),itr=new Map();for(const d of act){for(const e of(d.recipeIngredients||[])){const c=ir.get(e.ingredientId)||{t:0,p:99};c.t+=e.qty;c.p=Math.min(c.p,d.priority);ir.set(e.ingredientId,c)}for(const e of(d.recipeIntermediates||[])){const c=itr.get(e.intermediateId)||{t:0,p:99};c.t+=e.qty;c.p=Math.min(c.p,d.priority);itr.set(e.intermediateId,c)}}const itm=new Map(ints.map(i=>[i.id,i]));for(const[id,r]of itr){const t=itm.get(id);if(!t)continue;const df=Math.max(0,r.t-t.stockQty);if(df>0&&t.inputIngredients)for(const inp of t.inputIngredients){const c=ir.get(inp.ingredientId)||{t:0,p:99};c.t+=inp.qtyPerUnit*df;c.p=Math.min(c.p,r.p);ir.set(inp.ingredientId,c)}}const im=new Map(ings.map(i=>[i.id,i])),list=[];for(const[id,r]of ir){const i=im.get(id);if(!i)continue;const df=Math.max(0,r.t-i.stockQty);list.push({id,nm:i.name,u:i.unit,st:i.stockQty,need:r.t,df,buy:df>0,pri:r.p})}list.sort((a,b)=>a.buy!==b.buy?(a.buy?-1:1):a.pri-b.pri);return{list,toBuy:list.filter(i=>i.buy).length}};

const IngForm=({init,onSave,onX})=>{const[n,sN]=useState(init?.name||''),[u,sU]=useState(init?.unit||'g'),[s,sS]=useState(init?.stockQty||0),[sh,sSh]=useState(init?.shelfLifeDays||7);const sub=e=>{e.preventDefault();if(!n.trim())return;onSave({name:n.trim(),unit:u,stockQty:s,shelfLifeDays:sh})};return<form onSubmit={sub} className="space-y-4"><div><label className="block text-sm font-medium mb-1">Name</label><input value={n} onChange={e=>sN(e.target.value)} className="w-full px-4 py-2 rounded-lg border"/></div><div><label className="block text-sm font-medium mb-1">Unit</label><select value={u} onChange={e=>sU(e.target.value)} className="w-full px-4 py-2 rounded-lg border">{['g','kg','ml','L','pieces','cups'].map(x=><option key={x}>{x}</option>)}</select></div><div><label className="block text-sm font-medium mb-1">Stock</label><input type="number" value={s} onChange={e=>sS(+e.target.value||0)} onFocus={e=>e.target.select()} className="w-full px-4 py-2 rounded-lg border"/></div><div><label className="block text-sm font-medium mb-1">Shelf Life (days)</label><input type="number" value={sh} onChange={e=>sSh(+e.target.value||1)} onFocus={e=>e.target.select()} className="w-full px-4 py-2 rounded-lg border"/></div><div className="flex gap-3 pt-4 border-t"><button type="button" onClick={onX} className="flex-1 py-2 rounded-lg border">Cancel</button><button type="submit" className="flex-1 py-2 rounded-lg bg-terracotta text-white">{init?'Update':'Add'}</button></div></form>};

const BuyDlg=({i,sug,onBuy,onX})=>{const[q,sQ]=useState(sug||1);return<div className="space-y-4"><div className="bg-cream rounded-xl p-4"><h3 className="font-semibold">{i.name}</h3><p className="text-sm text-warm-gray">Current: {i.stockQty} {i.unit}</p></div><div><label className="block text-sm font-medium mb-1">Qty ({i.unit})</label><input type="number" value={q} onChange={e=>sQ(+e.target.value||0)} onFocus={e=>e.target.select()} className="w-full px-4 py-2 rounded-lg border text-lg" autoFocus/>{sug&&<p className="text-xs text-sage mt-1">Suggested: {sug} {i.unit}</p>}</div><div className="bg-sage/10 rounded-xl p-4 flex justify-between"><div><span className="text-sm text-warm-gray">Now</span><div className="font-medium">{i.stockQty} {i.unit}</div></div><div className="text-right"><span className="text-sm text-warm-gray">After</span><div className="font-medium text-sage">{(i.stockQty+q).toFixed(1)} {i.unit}</div></div></div><div className="flex gap-3"><button onClick={onX} className="flex-1 py-2 rounded-lg border">Cancel</button><button onClick={()=>q>0&&onBuy(q)} disabled={q<=0} className={`flex-1 py-2 rounded-lg text-white ${q>0?'bg-terracotta':'bg-light-gray cursor-not-allowed'}`}>Buy</button></div></div>};

const IntForm=({init,ings,onSave,onX})=>{const[n,sN]=useState(init?.name||''),[u,sU]=useState(init?.unit||'portions'),[s,sS]=useState(init?.stockQty||0),[inp,sInp]=useState(init?.inputIngredients||[]);const add=()=>{const un=ings.filter(i=>!inp.some(x=>x.ingredientId===i.id));if(un.length)sInp([...inp,{ingredientId:un[0].id,qtyPerUnit:1}])};const sub=e=>{e.preventDefault();if(!n.trim())return;onSave({name:n.trim(),unit:u,stockQty:s,inputIngredients:inp})};return<form onSubmit={sub} className="space-y-4"><div><label className="block text-sm font-medium mb-1">Name</label><input value={n} onChange={e=>sN(e.target.value)} placeholder="e.g., Pizza Dough" className="w-full px-4 py-2 rounded-lg border"/></div><div><label className="block text-sm font-medium mb-1">Unit</label><select value={u} onChange={e=>sU(e.target.value)} className="w-full px-4 py-2 rounded-lg border">{['portions','batches','cups','g','ml'].map(x=><option key={x}>{x}</option>)}</select></div><div><label className="block text-sm font-medium mb-1">Stock</label><input type="number" value={s} onChange={e=>sS(+e.target.value||0)} onFocus={e=>e.target.select()} className="w-full px-4 py-2 rounded-lg border"/></div><div className="border-t pt-4"><div className="flex justify-between mb-2"><span className="text-sm font-medium">Inputs (per 1 {u})</span><button type="button" onClick={add} className="text-sm text-purple flex items-center gap-1"><I.Plus/>Add</button></div>{!inp.length?<p className="text-sm text-amber-600">âš ï¸ No inputs</p>:<div className="space-y-2">{inp.map((x,i)=>{const ig=ings.find(g=>g.id===x.ingredientId);return<div key={i} className="flex gap-2 items-center"><select value={x.ingredientId} onChange={e=>{const u=[...inp];u[i]={...u[i],ingredientId:e.target.value};sInp(u)}} className="flex-1 px-2 py-1.5 rounded border text-sm">{ings.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}</select><input type="number" value={x.qtyPerUnit} onChange={e=>{const u=[...inp];u[i]={...u[i],qtyPerUnit:+e.target.value||0};sInp(u)}} className="w-16 px-2 py-1.5 rounded border text-sm text-center"/><span className="text-xs text-warm-gray">{ig?.unit}</span><button type="button" onClick={()=>sInp(inp.filter((_,j)=>j!==i))} className="p-1 text-warm-gray hover:text-tomato"><I.Del/></button></div>})}</div>}</div><div className="flex gap-3 pt-4 border-t"><button type="button" onClick={onX} className="flex-1 py-2 rounded-lg border">Cancel</button><button type="submit" className="flex-1 py-2 rounded-lg bg-purple text-white">{init?'Update':'Add'}</button></div></form>};

const PrepDlg=({t,ings,onPrep,onX})=>{const[u,sU]=useState(1);const need=(t.inputIngredients||[]).map(x=>({...x,ig:ings.find(i=>i.id===x.ingredientId),tot:x.qtyPerUnit*u}));const canPrep=need.every(n=>n.ig&&n.ig.stockQty>=n.tot)&&u>0;return<div className="space-y-4"><div className="bg-purple/10 rounded-xl p-4"><h3 className="font-semibold">{t.name}</h3><p className="text-sm text-warm-gray">Stock: {t.stockQty} {t.unit}</p></div><div><label className="block text-sm font-medium mb-1">Units to prepare</label><input type="number" value={u} onChange={e=>sU(Math.max(1,+e.target.value||1))} onFocus={e=>e.target.select()} className="w-full px-4 py-2 rounded-lg border text-lg" autoFocus/></div><div className="bg-cream rounded-xl p-4"><p className="text-sm text-warm-gray mb-2">Will deduct:</p><ul className="text-sm space-y-1">{need.map((n,i)=>{const short=n.ig&&n.ig.stockQty<n.tot;return<li key={i} className="flex justify-between"><span className={short?'text-tomato font-medium':''}>{n.ig?.name}{short&&' ⚠'}</span><span className={short?'text-tomato':'text-warm-gray'}>-{n.tot} {n.ig?.unit}{short&&` (have ${n.ig.stockQty})`}</span></li>})}</ul></div><div className="bg-sage/10 rounded-xl p-4 flex justify-between"><div><span className="text-sm text-warm-gray">Now</span><div className="font-medium">{t.stockQty}</div></div><div className="text-right"><span className="text-sm text-warm-gray">After</span><div className="font-medium text-purple">{t.stockQty+u}</div></div></div>{!canPrep&&<p className="text-sm text-tomato text-center">⚠ Insufficient ingredients for {u} {t.unit}</p>}<div className="flex gap-3"><button onClick={onX} className="flex-1 py-2 rounded-lg border">Cancel</button><button onClick={()=>canPrep&&onPrep(u)} disabled={!canPrep} className={`flex-1 py-2 rounded-lg text-white ${canPrep?'bg-purple':'bg-light-gray cursor-not-allowed'}`}>Prepare</button></div></div>};

const DishForm=({init,ings,ints,onSave,onX})=>{const[n,sN]=useState(init?.name||''),[p,sP]=useState(init?.priority||3),[ri,sRi]=useState(init?.recipeIngredients||[]),[rt,sRt]=useState(init?.recipeIntermediates||[]);const addI=()=>{const un=ings.filter(i=>!ri.some(x=>x.ingredientId===i.id));if(un.length)sRi([...ri,{ingredientId:un[0].id,qty:1}])};const addT=()=>{const un=ints.filter(i=>!rt.some(x=>x.intermediateId===i.id));if(un.length)sRt([...rt,{intermediateId:un[0].id,qty:1}])};const sub=e=>{e.preventDefault();if(!n.trim())return;onSave({name:n.trim(),priority:p,recipeIngredients:ri,recipeIntermediates:rt})};return<form onSubmit={sub} className="space-y-4"><div><label className="block text-sm font-medium mb-1">Dish Name</label><input value={n} onChange={e=>sN(e.target.value)} className="w-full px-4 py-2 rounded-lg border"/></div><div><label className="block text-sm font-medium mb-1">Priority</label><select value={p} onChange={e=>sP(+e.target.value)} className="w-full px-4 py-2 rounded-lg border">{[1,2,3,4,5].map(x=><option key={x} value={x}>{['Urgent','High','Normal','Low','Someday'][x-1]}</option>)}</select></div><div className="border-t pt-4"><div className="flex justify-between mb-2"><span className="text-sm font-medium">Ingredients</span><button type="button" onClick={addI} className="text-sm text-terracotta flex items-center gap-1"><I.Plus/>Add</button></div>{!ri.length?<p className="text-sm text-warm-gray">None</p>:<div className="space-y-2">{ri.map((x,i)=>{const ig=ings.find(g=>g.id===x.ingredientId);return<div key={i} className="flex gap-2 items-center"><select value={x.ingredientId} onChange={e=>{const u=[...ri];u[i]={...u[i],ingredientId:e.target.value};sRi(u)}} className="flex-1 px-2 py-1.5 rounded border text-sm">{ings.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}</select><input type="number" value={x.qty} onChange={e=>{const u=[...ri];u[i]={...u[i],qty:+e.target.value||0};sRi(u)}} className="w-16 px-2 py-1.5 rounded border text-sm text-center"/><span className="text-xs text-warm-gray">{ig?.unit}</span><button type="button" onClick={()=>sRi(ri.filter((_,j)=>j!==i))} className="p-1 text-warm-gray hover:text-tomato"><I.Del/></button></div>})}</div>}</div><div className="border-t pt-4"><div className="flex justify-between mb-2"><span className="text-sm font-medium">Preparations</span><button type="button" onClick={addT} disabled={!ints.length} className="text-sm text-purple flex items-center gap-1 disabled:opacity-50"><I.Plus/>Add</button></div>{!rt.length?<p className="text-sm text-warm-gray">{ints.length?'None':'Create preps first'}</p>:<div className="space-y-2">{rt.map((x,i)=>{const it=ints.find(t=>t.id===x.intermediateId);return<div key={i} className="flex gap-2 items-center"><select value={x.intermediateId} onChange={e=>{const u=[...rt];u[i]={...u[i],intermediateId:e.target.value};sRt(u)}} className="flex-1 px-2 py-1.5 rounded border border-purple/30 bg-purple/5 text-sm">{ints.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</select><input type="number" value={x.qty} onChange={e=>{const u=[...rt];u[i]={...u[i],qty:+e.target.value||0};sRt(u)}} className="w-16 px-2 py-1.5 rounded border border-purple/30 text-sm text-center"/><span className="text-xs text-warm-gray">{it?.unit}</span><button type="button" onClick={()=>sRt(rt.filter((_,j)=>j!==i))} className="p-1 text-warm-gray hover:text-tomato"><I.Del/></button></div>})}</div>}</div>{!ri.length&&!rt.length&&<p className="text-sm text-amber-600">âš ï¸ Will be unlinked</p>}<div className="flex gap-3 pt-4 border-t"><button type="button" onClick={onX} className="flex-1 py-2 rounded-lg border">Cancel</button><button type="submit" className="flex-1 py-2 rounded-lg bg-terracotta text-white">{init?'Update':'Add'}</button></div></form>};

const App=()=>{
  const[pg,sPg]=useState('ing'),[ings,sIngs]=useState([]),[dishes,sDishes]=useState([]),[ints,sInts]=useState([]),[ld,sLd]=useState(true),[m,sM]=useState({}),[toast,sToast]=useState(null);
  const notify=(msg,type='error')=>sToast({msg,type,k:Date.now()});
  useEffect(()=>{(async()=>{sIngs(await db.ingredients.toArray());sDishes(await db.dishes.toArray());sInts(await db.intermediates.toArray());sLd(false)})()},[]);
  const eIngs=useMemo(()=>ings.map(i=>({...i,inStock:i.stockQty>0,...spg(i)})),[ings]);
  const eInts=useMemo(()=>ints.map(t=>({...t,inStock:t.stockQty>0,...chkInt(t,ings)})),[ints,ings]);
  const eDishes=useMemo(()=>dishes.map(d=>({...d,isActive:d.status!=='Cooked',...chkDish(d,ings,ints)})),[dishes,ings,ints]);
  const shop=useMemo(()=>agg(dishes,ings,ints),[dishes,ings,ints]);

  const addIng=async d=>{const i={id:gid(),...d,purchasedAt:null};await db.ingredients.add(i);sIngs([...ings,i])};
  const editIng=async(id,d)=>{await db.ingredients.update(id,d);sIngs(ings.map(i=>i.id===id?{...i,...d}:i))};
  const delIng=async id=>{await db.ingredients.delete(id);sIngs(ings.filter(i=>i.id!==id))};
  const buyIng=async(id,q)=>{if(q<=0)return notify('Purchase quantity must be greater than 0');const ig=ings.find(i=>i.id===id);if(!ig)return notify('Ingredient not found');const u={stockQty:ig.stockQty+q,purchasedAt:new Date().toISOString()};await db.ingredients.update(id,u);sIngs(ings.map(i=>i.id===id?{...i,...u}:i));notify(`Bought ${q} ${ig.unit} of ${ig.name}`,'success')};

  const addInt=async d=>{const t={id:gid(),...d};await db.intermediates.add(t);sInts([...ints,t])};
  const editInt=async(id,d)=>{await db.intermediates.update(id,d);sInts(ints.map(t=>t.id===id?{...t,...d}:t))};
  const delInt=async id=>{await db.intermediates.delete(id);sInts(ints.filter(t=>t.id!==id))};
  const prepInt=async(id,u)=>{const t=ints.find(x=>x.id===id);if(!t)return notify('Preparation not found');if(u<=0)return notify('Units must be greater than 0');const im=new Map(ings.map(i=>[i.id,i]));for(const inp of(t.inputIngredients||[])){const ig=im.get(inp.ingredientId);if(!ig)return notify(`Input ingredient missing`);if(ig.stockQty<inp.qtyPerUnit*u)return notify(`Not enough ${ig.name}: need ${inp.qtyPerUnit*u}, have ${ig.stockQty}`)}try{await db.transaction('rw',db.ingredients,db.intermediates,async()=>{for(const inp of(t.inputIngredients||[])){const ig=im.get(inp.ingredientId);const ns=ig.stockQty-inp.qtyPerUnit*u;if(ns<0)throw new Error('Negative stock');await db.ingredients.update(inp.ingredientId,{stockQty:ns})}await db.intermediates.update(id,{stockQty:t.stockQty+u})});const ui=[...ings];for(const inp of(t.inputIngredients||[])){const idx=ui.findIndex(i=>i.id===inp.ingredientId);if(idx!==-1)ui[idx]={...ui[idx],stockQty:ui[idx].stockQty-inp.qtyPerUnit*u}}sIngs(ui);sInts(ints.map(x=>x.id===id?{...x,stockQty:x.stockQty+u}:x));notify(`Prepared ${u} ${t.unit} of ${t.name}`,'success')}catch(e){notify('Preparation failed: '+e.message)}};

  const addDish=async d=>{const x={id:gid(),...d,status:'Planned'};await db.dishes.add(x);sDishes([...dishes,x])};
  const editDish=async(id,d)=>{await db.dishes.update(id,d);sDishes(dishes.map(x=>x.id===id?{...x,...d}:x))};
  const delDish=async id=>{await db.dishes.delete(id);sDishes(dishes.filter(x=>x.id!==id))};
  const cookDish=async id=>{const d=dishes.find(x=>x.id===id);if(!d)return notify('Dish not found');if(d.status==='Cooked')return notify('Dish is already cooked');const im=new Map(ings.map(i=>[i.id,i])),itm=new Map(ints.map(i=>[i.id,i]));for(const e of(d.recipeIngredients||[])){const ig=im.get(e.ingredientId);if(!ig)return notify(`Ingredient missing`);if(ig.stockQty<e.qty)return notify(`Not enough ${ig.name}: need ${e.qty}, have ${ig.stockQty}`)}for(const e of(d.recipeIntermediates||[])){const it=itm.get(e.intermediateId);if(!it)return notify(`Preparation missing`);if(it.stockQty<e.qty)return notify(`Not enough ${it.name}: need ${e.qty}, have ${it.stockQty}`)}try{await db.transaction('rw',db.ingredients,db.intermediates,db.dishes,async()=>{for(const e of(d.recipeIngredients||[])){const ig=im.get(e.ingredientId);const ns=ig.stockQty-e.qty;if(ns<0)throw new Error('Negative stock');await db.ingredients.update(e.ingredientId,{stockQty:ns})}for(const e of(d.recipeIntermediates||[])){const it=itm.get(e.intermediateId);const ns=it.stockQty-e.qty;if(ns<0)throw new Error('Negative stock');await db.intermediates.update(e.intermediateId,{stockQty:ns})}await db.dishes.update(id,{status:'Cooked'})});const ui=[...ings];for(const e of(d.recipeIngredients||[])){const idx=ui.findIndex(i=>i.id===e.ingredientId);if(idx!==-1)ui[idx]={...ui[idx],stockQty:ui[idx].stockQty-e.qty}}sIngs(ui);const ut=[...ints];for(const e of(d.recipeIntermediates||[])){const idx=ut.findIndex(t=>t.id===e.intermediateId);if(idx!==-1)ut[idx]={...ut[idx],stockQty:ut[idx].stockQty-e.qty}}sInts(ut);sDishes(dishes.map(x=>x.id===id?{...x,status:'Cooked'}:x));notify(`${d.name} cooked!`,'success')}catch(e){notify('Cook failed: '+e.message)}};

  if(ld)return<div className="min-h-screen bg-cream flex items-center justify-center"><div className="w-8 h-8 border-2 border-terracotta border-t-transparent rounded-full animate-spin"/></div>;

  const IngPg=()=><div className="min-h-screen bg-cream pb-24"><header className="bg-white border-b sticky top-0 z-10"><div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl bg-terracotta/10 flex items-center justify-center text-terracotta"><I.Pkg/></div><div><h1 className="font-semibold text-xl">Ingredients</h1><p className="text-sm text-warm-gray">Raw materials</p></div></div><button onClick={()=>sM({t:'addIng'})} className="p-2.5 rounded-lg bg-terracotta text-white"><I.Plus/></button></div></header><main className="max-w-4xl mx-auto px-4 py-6">{!eIngs.length?<p className="text-center py-16 text-warm-gray">No ingredients</p>:<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{eIngs.map(i=><div key={i.id} className="bg-white rounded-xl border p-4 fade"><div className="flex justify-between"><div><h3 className="font-semibold">{i.name}</h3><p className={`text-sm ${i.inStock?'':'text-tomato'}`}>{i.stockQty} {i.unit}</p></div><SpBadge st={i.st} d={i.d}/></div><p className="text-xs text-warm-gray mt-2">Shelf: {i.shelfLifeDays}d</p><div className="flex gap-1 mt-3 pt-3 border-t"><button onClick={()=>sM({t:'buyIng',d:i})} className="flex-1 py-1.5 rounded text-sm text-terracotta hover:bg-terracotta/10">Buy</button><button onClick={()=>sM({t:'editIng',d:i})} className="p-1.5 rounded text-warm-gray hover:bg-light-gray/20"><I.Edit/></button><button onClick={()=>{if(confirm(`Delete ${i.name}?`))delIng(i.id)}} className="p-1.5 rounded text-warm-gray hover:text-tomato"><I.Del/></button></div></div>)}</div>}</main></div>;

  const IntPg=()=><div className="min-h-screen bg-cream pb-24"><header className="bg-white border-b sticky top-0 z-10"><div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl bg-purple/10 flex items-center justify-center text-purple"><I.Layer/></div><div><h1 className="font-semibold text-xl">Preparations</h1><p className="text-sm text-warm-gray">Dough, sauces...</p></div></div><button onClick={()=>sM({t:'addInt'})} className="p-2.5 rounded-lg bg-purple text-white"><I.Plus/></button></div></header><main className="max-w-4xl mx-auto px-4 py-6">{!eInts.length?<p className="text-center py-16 text-warm-gray">No preparations</p>:<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{eInts.map(t=><div key={t.id} className="bg-white rounded-xl border border-purple/30 p-4 fade"><div className="flex justify-between"><div><h3 className="font-semibold">{t.name}</h3><p className={`text-sm ${t.inStock?'':'text-tomato'}`}>{t.stockQty} {t.unit}</p></div>{t.ul?<span className="text-xs px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">Unlinked</span>:t.ok?<span className="text-xs px-2 py-0.5 rounded-full bg-sage/20 text-sage">Ready</span>:<span className="text-xs px-2 py-0.5 rounded-full bg-tomato/10 text-tomato">Missing</span>}</div><p className="text-xs text-warm-gray mt-2">Inputs: {(t.inputIngredients||[]).map(x=>ings.find(i=>i.id===x.ingredientId)?.name).filter(Boolean).join(', ')||'None'}</p><div className="flex gap-1 mt-3 pt-3 border-t"><button onClick={()=>sM({t:'prepInt',d:t})} disabled={!t.ok} className={`flex-1 py-1.5 rounded text-sm ${t.ok?'text-purple hover:bg-purple/10':'text-light-gray cursor-not-allowed'}`}>Prepare</button><button onClick={()=>sM({t:'editInt',d:t})} className="p-1.5 rounded text-warm-gray hover:bg-light-gray/20"><I.Edit/></button><button onClick={()=>{if(confirm(`Delete ${t.name}?`))delInt(t.id)}} className="p-1.5 rounded text-warm-gray hover:text-tomato"><I.Del/></button></div></div>)}</div>}</main></div>;

  const DishPg=()=>{const[f,sF]=useState('active');const fd=useMemo(()=>{let r=eDishes;if(f==='active')r=r.filter(d=>d.isActive);else if(f==='ready')r=r.filter(d=>d.isActive&&d.ok);else if(f==='cooked')r=r.filter(d=>!d.isActive);return r.sort((a,b)=>a.isActive===b.isActive?a.priority-b.priority:a.isActive?-1:1)},[eDishes,f]);return<div className="min-h-screen bg-cream pb-24"><header className="bg-white border-b sticky top-0 z-10"><div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl bg-terracotta/10 flex items-center justify-center text-terracotta"><I.Dish/></div><div><h1 className="font-semibold text-xl">Dishes</h1><p className="text-sm text-warm-gray">Plan & cook</p></div></div><button onClick={()=>sM({t:'addDish'})} className="p-2.5 rounded-lg bg-terracotta text-white"><I.Plus/></button></div></header><main className="max-w-4xl mx-auto px-4 py-6"><div className="flex gap-2 mb-6">{['active','ready','all','cooked'].map(x=><button key={x} onClick={()=>sF(x)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${f===x?'bg-terracotta text-white':'bg-white text-warm-gray'}`}>{x[0].toUpperCase()+x.slice(1)}</button>)}</div>{!fd.length?<p className="text-center py-16 text-warm-gray">{dishes.length?'No match':'No dishes'}</p>:<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{fd.map(d=><div key={d.id} className={`bg-white rounded-xl border p-4 fade ${!d.isActive&&'opacity-60'}`}><div className="flex justify-between"><div><h3 className="font-semibold">{d.name}</h3><div className="flex gap-2 mt-1"><span className={`text-xs px-2 py-0.5 rounded-full ${d.status==='Cooked'?'bg-sage/20 text-sage':'bg-blue-100 text-blue-700'}`}>{d.status}</span><PriBadge p={d.priority}/></div></div></div>{d.isActive&&<p className="text-xs mt-2">{d.ul?<span className="text-amber-600">âš ï¸ Unlinked</span>:d.ok?<span className="text-sage">âœ“ Ready</span>:<span className="text-tomato">Missing: {[...d.mi,...d.mt].join(', ')}</span>}</p>}<p className="text-xs text-warm-gray mt-2">{(d.recipeIngredients?.length||0)} ing, {(d.recipeIntermediates?.length||0)} prep</p><div className="flex gap-1 mt-3 pt-3 border-t">{d.isActive&&<button onClick={()=>sM({t:'cookDish',d})} disabled={!d.ok} className={`flex-1 py-1.5 rounded text-sm ${d.ok?'text-sage hover:bg-sage/10':'text-light-gray cursor-not-allowed'}`}>Cook</button>}<button onClick={()=>sM({t:'editDish',d})} className="p-1.5 rounded text-warm-gray hover:bg-light-gray/20"><I.Edit/></button><button onClick={()=>{if(confirm(`Delete ${d.name}?`))delDish(d.id)}} className="p-1.5 rounded text-warm-gray hover:text-tomato"><I.Del/></button></div></div>)}</div>}</main></div>};

  const ShopPg=()=>{const[all,sAll]=useState(false);const ls=all?shop.list:shop.list.filter(i=>i.buy);return<div className="min-h-screen bg-cream pb-24"><header className="bg-white border-b sticky top-0 z-10"><div className="max-w-4xl mx-auto px-4 py-4"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl bg-terracotta/10 flex items-center justify-center text-terracotta"><I.Cart/></div><div><h1 className="font-semibold text-xl">Shopping</h1><p className="text-sm text-warm-gray">Auto-generated</p></div></div>{shop.list.length>0&&<div className="mt-3 flex gap-3"><span className="text-sm px-3 py-1 rounded-full bg-tomato/10 text-tomato">{shop.toBuy} to buy</span><span className="text-sm px-3 py-1 rounded-full bg-sage/20 text-sage">{shop.list.length-shop.toBuy} ok</span></div>}</div></header><main className="max-w-4xl mx-auto px-4 py-6">{!shop.list.length?<p className="text-center py-16 text-warm-gray">Add dishes to see list</p>:<><div className="flex gap-2 mb-6"><button onClick={()=>sAll(false)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${!all?'bg-terracotta text-white':'bg-white text-warm-gray'}`}>To Buy ({shop.toBuy})</button><button onClick={()=>sAll(true)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${all?'bg-terracotta text-white':'bg-white text-warm-gray'}`}>All ({shop.list.length})</button></div><div className="space-y-3">{ls.map(i=><div key={i.id} className={`bg-white rounded-xl border p-4 ${i.buy?'border-tomato/30':'border-sage/30'}`}><div className="flex items-center gap-3"><div className="flex-1"><div className="flex items-center gap-2"><h3 className={`font-semibold ${!i.buy&&'text-warm-gray line-through'}`}>{i.nm}</h3><PriBadge p={i.pri}/></div><div className="flex gap-4 text-sm mt-1"><span>Have: <b>{i.st}</b></span><span>Need: <b>{i.need}</b></span>{i.buy&&<span className="text-tomato font-medium">Buy: {i.df}</span>}</div></div>{i.buy&&<button onClick={()=>{const ig=eIngs.find(x=>x.id===i.id);if(ig)sM({t:'buyIng',d:ig,sug:i.df})}} className="px-3 py-1.5 rounded-lg bg-terracotta text-white text-sm">Buy</button>}</div></div>)}{!ls.length&&<p className="text-center py-8 text-warm-gray">ðŸŽ‰ All set!</p>}</div></>}</main></div>};

  return<div>
    {toast&&<Toast key={toast.k} msg={toast.msg} type={toast.type} onDone={()=>sToast(null)}/>}
    {pg==='ing'&&<IngPg/>}{pg==='int'&&<IntPg/>}{pg==='dish'&&<DishPg/>}{pg==='shop'&&<ShopPg/>}
    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t z-20"><div className="max-w-4xl mx-auto flex justify-around">
      <button onClick={()=>sPg('ing')} className={`flex flex-col items-center gap-0.5 py-2 px-2 ${pg==='ing'?'text-terracotta':'text-warm-gray'}`}><I.Pkg/><span className="text-xs">Ingredients</span></button>
      <button onClick={()=>sPg('int')} className={`flex flex-col items-center gap-0.5 py-2 px-2 ${pg==='int'?'text-purple':'text-warm-gray'}`}><I.Layer/><span className="text-xs">Preps</span></button>
      <button onClick={()=>sPg('dish')} className={`flex flex-col items-center gap-0.5 py-2 px-2 ${pg==='dish'?'text-terracotta':'text-warm-gray'}`}><I.Dish/><span className="text-xs">Dishes</span></button>
      <button onClick={()=>sPg('shop')} className={`flex flex-col items-center gap-0.5 py-2 px-2 relative ${pg==='shop'?'text-terracotta':'text-warm-gray'}`}><I.Cart/><span className="text-xs">Shop</span>{shop.toBuy>0&&<span className="absolute top-1 right-0 w-4 h-4 bg-tomato text-white text-xs rounded-full flex items-center justify-center">{shop.toBuy}</span>}</button>
    </div></nav>
    <Modal open={m.t==='addIng'} close={()=>sM({})} title="Add Ingredient" ch={<IngForm onSave={d=>{addIng(d);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='editIng'} close={()=>sM({})} title="Edit Ingredient" ch={m.d&&<IngForm init={m.d} onSave={d=>{editIng(m.d.id,d);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='buyIng'} close={()=>sM({})} title="Buy" ch={m.d&&<BuyDlg i={m.d} sug={m.sug} onBuy={q=>{buyIng(m.d.id,q);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='addInt'} close={()=>sM({})} title="Add Preparation" ch={<IntForm ings={eIngs} onSave={d=>{addInt(d);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='editInt'} close={()=>sM({})} title="Edit Preparation" ch={m.d&&<IntForm init={m.d} ings={eIngs} onSave={d=>{editInt(m.d.id,d);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='prepInt'} close={()=>sM({})} title="Prepare" ch={m.d&&<PrepDlg t={m.d} ings={eIngs} onPrep={u=>{prepInt(m.d.id,u);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='addDish'} close={()=>sM({})} title="Add Dish" ch={<DishForm ings={eIngs} ints={eInts} onSave={d=>{addDish(d);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='editDish'} close={()=>sM({})} title="Edit Dish" ch={m.d&&<DishForm init={m.d} ings={eIngs} ints={eInts} onSave={d=>{editDish(m.d.id,d);sM({})}} onX={()=>sM({})}/>}/>
    <Modal open={m.t==='cookDish'} close={()=>sM({})} title="Cook" ch={m.d&&<div className="space-y-4"><div className="bg-sage/10 rounded-xl p-4"><h3 className="font-semibold">{m.d.name}</h3><p className="text-sm text-warm-gray mt-2">Will deduct:</p><ul className="text-sm mt-1 space-y-1">{(m.d.recipeIngredients||[]).map(e=>{const i=ings.find(x=>x.id===e.ingredientId);return<li key={e.ingredientId}>{i?.name}: -{e.qty}</li>})}{(m.d.recipeIntermediates||[]).map(e=>{const t=ints.find(x=>x.id===e.intermediateId);return<li key={e.intermediateId} className="text-purple">{t?.name}: -{e.qty}</li>})}</ul></div><div className="flex gap-3"><button onClick={()=>sM({})} className="flex-1 py-2 rounded-lg border">Cancel</button><button onClick={()=>{cookDish(m.d.id);sM({})}} className="flex-1 py-2 rounded-lg bg-sage text-white">Cook</button></div></div>}/>
  </div>
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
